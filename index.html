<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queen's University Course Prerequisites Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Roboto', 'Arial', sans-serif;
            background-color: #FFF8EB;
            color: #282828;
            overflow: hidden;
        }

        #header {
            background-color: #FFFFFF;
            padding: 15px 20px;
            border-bottom: 1px solid #D0B7B0;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        h1 {
            font-size: 20px;
            font-weight: 600;
            color: #282828;
            margin-right: 20px;
        }

        #searchBox {
            padding: 8px 12px;
            border: 1px solid #D0B7B0;
            border-radius: 4px;
            font-size: 14px;
            width: 250px;
            background-color: white;
            color: #282828;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid #D0B7B0;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            color: #282828;
        }

        .filter-btn:hover {
            background-color: #FFF8EB;
        }

        .filter-btn.active {
            background-color: #115799;
            color: white;
            border-color: #115799;
        }

        .filter-btn.active.stat {
            background-color: #1BBF8B;
            border-color: #1BBF8B;
        }

        .filter-btn.active.cisc {
            background-color: #D9691E;
            color: white;
            border-color: #D9691E;
        }

        #canvas-container {
            width: calc(100vw - 300px);
            height: calc(100vh - 120px);
            position: relative;
            float: left;
            padding: 80px;
            overflow: hidden;
        }

        svg {
            width: 100%;
            height: 100%;
        }

        .link {
            stroke: #656565;
            stroke-opacity: 0.3;
            stroke-width: 1.5px;
            fill: none;
            transition: all 0.3s;
        }

        .link.highlighted {
            stroke: #115799;
            stroke-opacity: 1;
            stroke-width: 3px;
        }

        .link.faded {
            stroke-opacity: 0.05;
        }

        .node {
            cursor: pointer;
            transition: all 0.3s;
        }

        .node circle {
            stroke: #fff;
            stroke-width: 2px;
            transition: all 0.3s;
        }

        .node.selected circle {
            stroke: #115799;
            stroke-width: 4px;
            filter: drop-shadow(0 0 8px rgba(17, 87, 153, 0.6));
        }

        .node.highlighted circle {
            stroke: #1BBF8B;
            stroke-width: 3px;
            filter: drop-shadow(0 0 6px rgba(27, 191, 139, 0.5));
        }

        .node.faded {
            opacity: 0.15;
        }

        .node-label {
            font-size: 10px;
            fill: #282828;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: central;
            font-weight: 500;
        }

        #tooltip {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.98);
            border: 1px solid #D0B7B0;
            border-radius: 6px;
            padding: 12px;
            pointer-events: none;
            display: none;
            box-shadow: 0 2px 8px rgba(40, 40, 40, 0.15);
            max-width: 300px;
            z-index: 1000;
        }

        #tooltip .course-code {
            font-weight: 600;
            font-size: 14px;
            color: #282828;
            margin-bottom: 4px;
        }

        #tooltip .course-name {
            font-size: 12px;
            color: #656565;
            margin-bottom: 8px;
        }

        #tooltip .course-info {
            font-size: 11px;
            color: #656565;
        }

        #sidebar {
            width: 300px;
            height: calc(100vh - 120px);
            background-color: #FFFFFF;
            border-left: 1px solid #D0B7B0;
            float: right;
            overflow-y: auto;
            padding: 20px;
            display: none;
        }

        #sidebar.active {
            display: block;
        }

        #sidebar h2 {
            font-size: 18px;
            font-weight: 600;
            color: #282828;
            margin-bottom: 8px;
        }

        #sidebar .course-title {
            font-size: 14px;
            color: #656565;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid #D0B7B0;
        }

        #sidebar h3 {
            font-size: 14px;
            font-weight: 600;
            color: #282828;
            margin-top: 16px;
            margin-bottom: 8px;
        }

        #sidebar ul {
            list-style: none;
            padding: 0;
        }

        #sidebar li {
            padding: 8px 0;
            font-size: 13px;
            color: #656565;
            border-bottom: 1px solid #FFF8EB;
            cursor: pointer;
            transition: all 0.2s;
        }

        #sidebar li:hover {
            color: #282828;
            padding-left: 8px;
            background-color: #FFF8EB;
        }

        #sidebar .empty-state {
            font-size: 13px;
            color: #D0B7B0;
            font-style: italic;
        }

        #sidebar .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #656565;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
        }

        #sidebar .close-btn:hover {
            color: #282828;
        }

        #legend {
            background-color: #FFFFFF;
            padding: 15px 20px;
            border-top: 1px solid #D0B7B0;
            display: flex;
            align-items: center;
            gap: 30px;
            font-size: 13px;
            flex-wrap: wrap;
            clear: both;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .legend-label {
            color: #656565;
            font-weight: 500;
        }

        #controls {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .arrow-marker {
            fill: #656565;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div id="header">
        <h1>Queen's Course Prerequisites</h1>
        <input type="text" id="searchBox" placeholder="Search courses...">
        <button class="filter-btn" data-filter="MATH">MATH</button>
        <button class="filter-btn" data-filter="STAT">STAT</button>
        <button class="filter-btn" data-filter="CISC">CISC</button>
        <div id="controls">
            <button class="filter-btn" id="resetBtn">Reset View</button>
        </div>
    </div>

    <div id="canvas-container">
        <svg id="graph"></svg>
        <div id="tooltip"></div>
    </div>

    <div id="sidebar">
        <button class="close-btn" onclick="closeSidebar()">Ã—</button>
        <h2 id="sidebar-course-code"></h2>
        <div class="course-title" id="sidebar-course-name"></div>
        
        <div id="sidebar-info"></div>
        
        <h3>Prerequisites:</h3>
        <ul id="sidebar-prerequisites"></ul>
        
        <h3>Follow-up Courses:</h3>
        <ul id="sidebar-followups"></ul>
    </div>

    <div id="legend">
        <div class="legend-item">
            <div class="legend-color" style="background-color: #115799;"></div>
            <span class="legend-label">Mathematics (MATH)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #1BBF8B;"></div>
            <span class="legend-label">Statistics (STAT)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #D9691E;"></div>
            <span class="legend-label">Computing (CISC)</span>
        </div>
        <div class="legend-item">
            <span class="legend-label" style="margin-left: 20px;">Node size = Credit units</span>
        </div>
    </div>

    <script>
        // Load graph data
        const graphDataUrl = 'graph.json';
        
        const colorScheme = {
            'MATH': '#5B90C8',   // Blue
            'STAT': '#1BBF8B',   // Bright Green
            'CISC': '#D9691E'    // Orange 
        };

        // Initialize SVG and containers
        const svg = d3.select('#graph');
        const container = svg.append('g');
        
        // Add zoom behavior
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', (event) => {
                container.attr('transform', event.transform);
            });
        
        svg.call(zoom);

        // Define arrow markers
        svg.append('defs').selectAll('marker')
            .data(['arrow'])
            .join('marker')
            .attr('id', 'arrow')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 20)
            .attr('refY', 0)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('class', 'arrow-marker');

        let graphData, simulation, link, node, label;
        let selectedNodes = new Set();
        let activeFilter = null;

        // Load and visualize data
        d3.json(graphDataUrl).then(data => {
            graphData = data;
            initializeGraph();
        });

        function initializeGraph() {
            const width = document.getElementById('canvas-container').clientWidth - 160;
            const height = document.getElementById('canvas-container').clientHeight - 160;

            // Create simulation with physics forces - TIGHTER SPACING
            simulation = d3.forceSimulation(graphData.nodes)
                .force('link', d3.forceLink(graphData.edges)
                    .id(d => d.id)
                    .distance(60)  // Reduced from 120 to 60
                    .strength(0.8))  // Increased from 0.5 to 0.8
                .force('charge', d3.forceManyBody()
                    .strength(-200))  // Reduced from -500 to -200
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide()
                    .radius(d => getNodeSize(d) + 3))  // Reduced from 5 to 3
                .force('x', d3.forceX(width / 2).strength(0.05))  // Add gentle centering
                .force('y', d3.forceY(height / 2).strength(0.05))
                .alphaDecay(0.01);  // Slower decay for better settling

            // Create links
            link = container.append('g')
                .selectAll('path')
                .data(graphData.edges)
                .join('path')
                .attr('class', 'link')
                .attr('marker-end', 'url(#arrow)');

            // Create nodes
            node = container.append('g')
                .selectAll('g')
                .data(graphData.nodes)
                .join('g')
                .attr('class', 'node')
                .call(drag(simulation));

            node.append('circle')
                .attr('r', d => getNodeSize(d))
                .attr('fill', d => colorScheme[d.subject] || '#C4B5A0')
                .attr('opacity', d => graphData.components.isolated.includes(d.id) ? 0.7 : 1);

            // Add labels (show code for all nodes)
            label = container.append('g')
                .selectAll('text')
                .data(graphData.nodes)
                .join('text')
                .attr('class', 'node-label')
                .text(d => d.code.replace(/[A-Z]+\s/, ''))  // Show just the number
                .attr('dy', 0.5);

            // Event handlers
            node.on('mouseover', handleMouseOver)
                .on('mouseout', handleMouseOut)
                .on('click', handleClick);

            // Update positions on simulation tick
            simulation.on('tick', () => {
                link.attr('d', linkArc);
                
                node.attr('transform', d => `translate(${d.x},${d.y})`);
                label.attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }

        function getNodeSize(d) {
            // Size based on credit units: 3.0 units = radius 8, 6.0 units = radius 12
            return 6 + (d.units * 1.5);
        }

        function linkArc(d) {
            const dx = d.target.x - d.source.x;
            const dy = d.target.y - d.source.y;
            const dr = Math.sqrt(dx * dx + dy * dy);
            return `M${d.source.x},${d.source.y}L${d.target.x},${d.target.y}`;
        }

        function handleMouseOver(event, d) {
            const tooltip = document.getElementById('tooltip');
            const prereqText = d.prerequisites.length > 0 
                ? d.prerequisites.join(', ') 
                : 'None';
            
            tooltip.innerHTML = `
                <div class="course-code">${d.code}</div>
                <div class="course-name">${d.fullName}</div>
                <div class="course-info">
                    <strong>Credits:</strong> ${d.units} units<br>
                    <strong>Prerequisites:</strong> ${prereqText}<br>
                    <strong>Follow-up courses:</strong> ${d.followupCount}
                </div>
            `;
            
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY + 10) + 'px';

            // Highlight connected nodes
            highlightConnections(d);
        }

        function handleMouseOut() {
            document.getElementById('tooltip').style.display = 'none';
            clearHighlight();
        }

        let selectedNode = null;

        function handleClick(event, d) {
            event.stopPropagation();
            
            // If clicking the same node, deselect
            if (selectedNode && selectedNode.id === d.id) {
                deselectNode();
                return;
            }
            
            // Select new node
            selectedNode = d;
            showSidebar(d);
            highlightNode(d);
        }

        function showSidebar(d) {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.add('active');
            
            // Set course info
            document.getElementById('sidebar-course-code').textContent = d.code;
            document.getElementById('sidebar-course-name').textContent = d.fullName;
            
            // Set additional info
            document.getElementById('sidebar-info').innerHTML = `
                <p style="font-size: 13px; color: #656565; margin-bottom: 12px;">
                    <strong>Credits:</strong> ${d.units} units<br>
                    <strong>Level:</strong> ${d.level}<br>
                    <strong>Subject:</strong> ${d.subject}
                </p>
            `;
            
            // Set prerequisites
            const prereqList = document.getElementById('sidebar-prerequisites');
            prereqList.innerHTML = '';
            if (d.prerequisites && d.prerequisites.length > 0) {
                d.prerequisites.forEach(prereq => {
                    const li = document.createElement('li');
                    li.textContent = prereq;
                    li.onclick = () => {
                        const prereqNode = graphData.nodes.find(n => n.code === prereq);
                        if (prereqNode) {
                            handleClick(event, prereqNode);
                        }
                    };
                    prereqList.appendChild(li);
                });
            } else {
                prereqList.innerHTML = '<li class="empty-state">None</li>';
            }
            
            // Set follow-ups
            const followupList = document.getElementById('sidebar-followups');
            followupList.innerHTML = '';
            const followups = graphData.edges
                .filter(e => e.source.id === d.id || e.source === d.id)
                .map(e => e.target.code || graphData.nodes.find(n => n.id === e.target).code);
            
            if (followups.length > 0) {
                followups.forEach(followup => {
                    const li = document.createElement('li');
                    li.textContent = followup;
                    li.onclick = () => {
                        const followupNode = graphData.nodes.find(n => n.code === followup);
                        if (followupNode) {
                            handleClick(event, followupNode);
                        }
                    };
                    followupList.appendChild(li);
                });
            } else {
                followupList.innerHTML = '<li class="empty-state">None</li>';
            }
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            deselectNode();
        }

        function highlightNode(d) {
            // Get connected nodes
            const connected = new Set([d.id]);
            const directConnections = new Set([d.id]);
            
            // Add prerequisites (incoming edges)
            graphData.edges.forEach(edge => {
                if (edge.target.id === d.id || edge.target === d.id) {
                    const sourceId = edge.source.id || edge.source;
                    connected.add(sourceId);
                    directConnections.add(sourceId);
                }
                // Add follow-ups (outgoing edges)
                if (edge.source.id === d.id || edge.source === d.id) {
                    const targetId = edge.target.id || edge.target;
                    connected.add(targetId);
                    directConnections.add(targetId);
                }
            });

            // Update nodes
            node.classed('faded', n => !connected.has(n.id))
                .classed('highlighted', n => directConnections.has(n.id) && n.id !== d.id)
                .classed('selected', n => n.id === d.id);
            
            // Update links
            link.classed('highlighted', l => {
                const sourceId = l.source.id || l.source;
                const targetId = l.target.id || l.target;
                return (sourceId === d.id || targetId === d.id);
            }).classed('faded', l => {
                const sourceId = l.source.id || l.source;
                const targetId = l.target.id || l.target;
                return !(sourceId === d.id || targetId === d.id);
            });
        }

        function deselectNode() {
            selectedNode = null;
            node.classed('faded', false)
                .classed('highlighted', false)
                .classed('selected', false);
            link.classed('highlighted', false)
                .classed('faded', false);
        }

        function handleMouseOver(event, d) {
            if (selectedNode) return; // Don't show tooltip if node is selected
            
            const tooltip = document.getElementById('tooltip');
            const prereqText = d.prerequisites.length > 0 
                ? d.prerequisites.join(', ') 
                : 'None';
            
            tooltip.innerHTML = `
                <div class="course-code">${d.code}</div>
                <div class="course-name">${d.fullName}</div>
                <div class="course-info">
                    <strong>Credits:</strong> ${d.units} units<br>
                    <strong>Prerequisites:</strong> ${prereqText}<br>
                    <strong>Follow-up courses:</strong> ${d.followupCount}
                </div>
            `;
            
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY + 10) + 'px';
        }

        function handleMouseOut() {
            if (selectedNode) return;
            document.getElementById('tooltip').style.display = 'none';
        }

        function drag(simulation) {
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            return d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended);
        }

        // Filter buttons
        document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
            btn.addEventListener('click', () => {
                const filter = btn.dataset.filter;
                
                if (activeFilter === filter) {
                    // Toggle off
                    activeFilter = null;
                    btn.classList.remove('active', filter.toLowerCase());
                    node.style('opacity', 1);
                    link.style('opacity', 0.3);
                } else {
                    // Toggle on
                    document.querySelectorAll('.filter-btn[data-filter]').forEach(b => {
                        b.classList.remove('active', 'math', 'stat', 'cisc');
                    });
                    activeFilter = filter;
                    btn.classList.add('active', filter.toLowerCase());
                    
                    // Filter nodes
                    node.style('opacity', d => d.subject === filter ? 1 : 0.15);
                    link.style('opacity', l => 
                        l.source.subject === filter || l.target.subject === filter ? 0.3 : 0.05
                    );
                }
            });
        });

        // Search functionality
        const searchBox = document.getElementById('searchBox');
        searchBox.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            
            if (query.length === 0) {
                node.style('opacity', 1);
                link.style('opacity', 0.3);
                return;
            }

            node.style('opacity', d => {
                const match = d.code.toLowerCase().includes(query) || 
                              d.fullName.toLowerCase().includes(query);
                return match ? 1 : 0.15;
            });

            link.style('opacity', l => {
                const sourceMatch = l.source.code.toLowerCase().includes(query) || 
                                   l.source.fullName.toLowerCase().includes(query);
                const targetMatch = l.target.code.toLowerCase().includes(query) || 
                                   l.target.fullName.toLowerCase().includes(query);
                return (sourceMatch || targetMatch) ? 0.3 : 0.05;
            });
        });

        // Reset button
        document.getElementById('resetBtn').addEventListener('click', () => {
            // Reset filters
            activeFilter = null;
            document.querySelectorAll('.filter-btn[data-filter]').forEach(b => {
                b.classList.remove('active', 'math', 'stat', 'cisc');
            });
            searchBox.value = '';
            
            // Close sidebar and clear selection
            closeSidebar();
            
            // Reset opacities
            node.style('opacity', 1);
            link.style('opacity', 0.3);
            
            // Reset zoom
            svg.transition()
                .duration(750)
                .call(zoom.transform, d3.zoomIdentity);
            
            // Restart simulation
            simulation.alpha(1).restart();
        });

        // Click on background to deselect
        svg.on('click', function(event) {
            if (event.target === this || event.target.tagName === 'svg') {
                closeSidebar();
            }
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            const width = document.getElementById('canvas-container').clientWidth - 160;
            const height = document.getElementById('canvas-container').clientHeight - 160;
            simulation.force('center', d3.forceCenter(width / 2, height / 2));
            simulation.alpha(0.3).restart();
        });
    </script>
</body>
</html>
